name: Build docs
on: push

jobs:
  build-docs:
    runs-on: ubuntu-latest
    steps:
    # - name: Cancel any previous incomplete runs
    #   uses: styfle/cancel-workflow-action@0.9.1
    #   with:
    #     all_but_latest: true
    #     access_token: ${{ github.token }}

    - uses: actions/checkout@v3
      with:
        submodules: 'recursive'

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'

    - name: Clone extension repo
      run: |
        # extract name, version, and src from ndx-meta.yaml

        version=`grep "version" ndx-meta.yaml | cut -f2- -d ":" | sed 's/ *//g'`
        echo $version
        src=`grep "src" ndx-meta.yaml | cut -f2- -d ":" | sed 's/ *//g'`
        echo $src

        git clone --depth 1 --branch $version $src.git

    - name: Build docs for extension repo
      run: |
        name=`grep "name" ndx-meta.yaml | cut -f2- -d ":" | sed 's/ *//g'`
        echo $name
        cd $name
        pip install -r requirements.txt  # install reqs, including hdmf_docutils
        pip install .  # install extension from source
        pip check
        pip show hdmf_docutils
        cd docs
        make html
        cd ../..
        mv $name/docs/_build docs/

        echo $version  # test

    - name: Commit and push docs to branch using nwb-extensions-bot account
      run: |
        git checkout gh-pages
        git add docs
        git commit -m "Update docs"
        git push